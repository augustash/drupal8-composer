!function(d,l,o){"use strict";function y(t){var e=t.getSelection().getSelectedElement();return u(t,e)?e:null}function u(t,e){var a=t.widgets.getByElement(e,!0);if(!a||"exoentity"!==a.name)return!1;var i=d(e.$.firstChild).attr("data-embed-button");return!!i&&t.config.ExoEntity_buttons.hasOwnProperty(i)}o.plugins.add("exoentity",{requires:"widget",beforeInit:function(a){var t,e=o.dtd;for(t in e["drupal-entity"]={"#":1},e)e[t].div&&(e[t]["drupal-entity"]=1);if(a.addCommand("editexoentity",{allowedContent:"drupal-entity[data-embed-button,data-entity-type,data-entity-uuid,data-entity-embed-display,data-entity-embed-display-settings,data-align,data-caption]",requiredContent:"drupal-entity[data-embed-button,data-entity-type,data-entity-uuid,data-entity-embed-display,data-entity-embed-display-settings,data-align,data-caption]",modes:{wysiwyg:1},canUndo:!0,exec:function(n,t){t=t||{};var d=y(n),e={};if(d&&d.$&&d.$.firstChild)for(var a,i=d.$.firstChild,o=null,u=0;u<i.attributes.length;u++)"data-cke-saved-"!==(a=(o=i.attributes.item(u)).nodeName.toLowerCase()).substring(0,15)&&(e[a]=d.data("cke-saved-"+a)||o.nodeValue);var r=t.id?t.id:e["data-embed-button"];l.ckeditor.openDialog(n,l.url("entity-embed/dialog/"+n.config.drupal.format+"/"+r),e,function(t){var e=n.document.createElement("drupal-entity"),a=t.attributes;for(var i in a)e.setAttribute(i,a[i]);n.insertHtml(e.getOuterHtml()),d&&(l.runEmbedBehaviors("detach",d.$),d.remove())},{dialogClass:"entity-select-dialog",resizable:!1})}}),a.widgets.add("exoentity",{allowedContent:"drupal-entity[data-entity-type,data-entity-uuid,data-entity-embed-display,data-entity-embed-display-settings,data-align,data-caption]",requiredContent:"drupal-entity[data-entity-type,data-entity-uuid,data-entity-embed-display,data-entity-embed-display-settings,data-align,data-caption]",upcast:function(t){var e=t.attributes;if(!(void 0===e["data-entity-type"]||void 0===e["data-entity-id"]&&void 0===e["data-entity-uuid"]||void 0===e["data-view-mode"]&&void 0===e["data-entity-embed-display"]))return t.attributes.id=function t(){void 0===t.counter&&(t.counter=0);return"entity-embed-"+t.counter++}(),t},init:function(){var t=this.element;l.ajax({base:t.getId(),element:t.$,url:l.url("embed/preview/"+a.config.drupal.format+"?"+d.param({value:t.getOuterHtml()})),progress:{type:"none"},event:"entity_embed_dummy_event"}).execute()},downcast:function(t){return t.setHtml(""),delete t.attributes.id,t}}),a.ui.addButton)for(var i in a.config.ExoEntity_buttons){var n=a.config.ExoEntity_buttons[i];a.ui.addButton(n.id,{label:n.label,data:n,allowedContent:"drupal-entity[!data-entity-type,!data-entity-uuid,!data-entity-embed-display,!data-entity-embed-display-settings,!data-align,!data-caption,!data-embed-button]",click:function(t){t.execCommand("editexoentity",this.data)},icon:"_ exo-icon exo-icon-font icon-"+n.icon+"  _"})}a.contextMenu&&(a.addMenuGroup("exoentity"),a.addMenuItem("exoentity",{label:l.t("Edit Entity"),icon:this.path+"entity.png",command:"editexoentity",group:"exoentity"}),a.contextMenu.addListener(function(t){if(u(a,t))return{exoentity:o.TRISTATE_OFF}})),a.on("doubleclick",function(t){var e=y(a)||t.data.element;u(a,e)&&a.execCommand("editexoentity")})}})}(jQuery,Drupal,CKEDITOR);