"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _get(e,t,i){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var o=_superPropBase(e,t);if(o){var n=Object.getOwnPropertyDescriptor(o,t);return n.get?n.get.call(i):n.value}})(e,t,i||e)}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}!function(c,e,u,d,r){var o=function(){function n(e,t){var i;return _classCallCheck(this,n),(i=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this,e))).label="ExoAlchemistField",i.doDebug=!1,i.focused=!1,i.clickTimer=0,i.clickCount=0,i.defaults={element:HTMLElement,label:"",cardinality:1,required:!1,delta:0,total:0,entity:"",bundle:"",path:""},i.admin=t,i}return _inherits(n,ExoData),_createClass(n,[{key:"build",value:function(i){var o=this;return new Promise(function(t,e){_get(_getPrototypeOf(n.prototype),"build",o).call(o,i).then(function(e){o.$element=c(e.element),o.$element.data("alchemist-field-id",o.getId()),o.bind(),t(e)})})}},{key:"bind",value:function(){var t=this;this.$element.on("click",function(e){e.preventDefault(),e.stopPropagation(),t.clickCount++,clearTimeout(t.clickTimer),t.clickTimer=setTimeout(function(){1<t.clickCount?(t.admin.getFieldOpsManager().focus(t,!1),t.admin.getFieldOpsManager().triggerOp("update")):t.admin.getFieldOpsManager().focus(t),t.clickCount=0},300)})}},{key:"accessOp",value:function(e){switch(e){case"prev":return 1!==this.getCardinality()&&0!==this.getDelta();case"next":return 1!==this.getCardinality()&&this.getTotal()!==this.getDelta()+1;case"clone":return 1!==this.getCardinality()&&this.getTotal()!==this.getCardinality();case"delete":return!1===this.isRequired()}return!0}},{key:"triggerOp",value:function(e){var o=this,t={},i=null;switch(e){case"update":case"clone":case"prev":case"next":case"delete":i=u.url("layout_builder/field/"+e+"/"+this.admin.getStorageType()+"/"+this.admin.getStorageId()+"/"+this.admin.getSectionDelta()+"/"+this.admin.getSectionRegion()+"/"+this.getSectionComponent()+"/"+this.getPath()+"?destination="+u.url(d.path.currentPath))}"update"===e&&(t.exo_modal={},t.exo_modal.overlayColor="transparent",t.exo_modal.icon="icon-regular-edit",t.exo_modal.subtitle="Make changes to the component field."),i?u.ajax({url:i,dialog:t,dialogType:"dialog",dialogRenderer:"off_canvas"}).execute().done(function(e,t,i){o.debug("info","Ajax request executed successfully.")}):this.debug("info","URL was not build for operation.")}},{key:"getElement",value:function(){return this.$element}},{key:"getLabel",value:function(){return this.get("label")}},{key:"getCardinality",value:function(){return this.get("cardinality")}},{key:"isRequired",value:function(){return!0===this.get("required")}},{key:"getSectionComponent",value:function(){return this.$element.closest("[data-exo-alchemist-section]").data("exo-alchemist-section")}},{key:"getDelta",value:function(){return this.get("delta")}},{key:"getTotal",value:function(){return this.get("total")}},{key:"getPath",value:function(){return this.get("path")}}]),n}(),n=function(){function t(e){_classCallCheck(this,t),this.activeField=null,this.events={allowFocus:new ExoEvent,showOps:new ExoEvent},this.admin=e,this.build()}return _createClass(t,[{key:"bind",value:function(){var t=this;this.admin.event("overlayHide").on("exo.alchemist.field.ops",function(e){null!==t.activeField&&(t.admin.getComponentManager().unlockFocus(),t.admin.getComponentManager().showPanel()),t.activeField=null}),this.admin.event("overlayHidden").on("exo.alchemist.field.ops",function(e){t.$fieldOps.find(".exo-alchemist-op-reset").addClass("hide")}),this.admin.getComponentManager().event("allowFocus").on("exo.alchemist.field.ops",function(e){null!==t.activeField&&(e.allow=!1)})}},{key:"build",value:function(){var t=this,e=this.admin.opClasses;this.$fieldOps=c('<div class="exo-alchemist-field-ops" />').appendTo(this.admin.getOverlay()),this.fieldOps={prev:c('<a href="#" title="Sort Previous" class="'+e+' exo-alchemist-field-op-prev hide"></a>').data("op","prev").appendTo(this.$fieldOps),update:c('<a href="#" title="Edit" class="'+e+' exo-alchemist-field-op-update hide"></a>').data("op","update").appendTo(this.$fieldOps),delete:c('<a href="#" title="Delete" class="'+e+' exo-alchemist-field-op-delete hide"></a>').data("op","delete").appendTo(this.$fieldOps),clone:c('<a href="#" title="Clone" class="'+e+' exo-alchemist-field-op-clone hide"></a>').data("op","clone").appendTo(this.$fieldOps),next:c('<a href="#" title="Sort Next" class="'+e+' exo-alchemist-field-op-next hide"></a>').data("op","next").appendTo(this.$fieldOps)},this.$fieldOps.find("a").on("click",function(e){e.preventDefault(),e.stopPropagation(),t.triggerOp(c(e.currentTarget).data("op"))})}},{key:"focus",value:function(e,t){var i=this,o={allow:!0};this.event("allowFocus").trigger(o),!0===o.allow&&(t=void 0===t||t,this.admin.getComponentManager().lockFocus(),this.admin.getComponentManager().hidePanel(),this.activeField=e,this.admin.showOverlay(e.getElement(),"field",110).then(function(){!0===t&&i.showOps(e)}))}},{key:"showOps",value:function(e){for(var t in this.fieldOps)if(this.fieldOps.hasOwnProperty(t)){var i=this.fieldOps[t];!0===e.accessOp(t)?i.removeClass("hide"):i.addClass("hide")}this.$fieldOps.removeClass("hide"),this.event("showOps").trigger(this)}},{key:"triggerOp",value:function(e){this.activeField&&(this.activeField.triggerOp(e),this.$fieldOps.addClass("hide"))}},{key:"getActive",value:function(){return this.activeField}},{key:"event",value:function(e){return void 0!==this.events[e]?this.events[e].expose():null}}]),t}(),a=function(){function t(e){_classCallCheck(this,t),this.events={},this.admin=e,this.build()}return _createClass(t,[{key:"bind",value:function(){var t=this;this.admin.getFieldOpsManager().event("showOps").on("exo.alchemist.field.breadcrumbs",function(e){t.rebuild()})}},{key:"build",value:function(){this.$fieldBreadcrumbs=c('<ul class="exo-alchemist-breadcrumbs" />').appendTo(this.admin.getOverlay())}},{key:"rebuild",value:function(){var n=this;this.$fieldBreadcrumbs.children().remove();var e=this.admin.getFieldOpsManager().getActive();if(e){var t=this.admin.getComponentManager().getActive().find(".exo-component-field-edit").not(e.getElement().find(".exo-component-field-edit")).overlaps(e.getElement()).add(e.getElement());c('<li class="exo-alchemist-breadcrumb-label">Nested Elements:</li>').appendTo(this.$fieldBreadcrumbs),t.each(function(e,t){var i=c(t).data("alchemist-field-id"),o=n.admin.getInstance(i);c('<li class="exo-alchemist-breadcrumb-field"><a>'+o.getLabel()+"</a></li>").on("click",function(e){e.preventDefault(),e.stopPropagation(),n.admin.getFieldOpsManager().focus(o)}).appendTo(n.$fieldBreadcrumbs)})}}}]),t}(),s=function(){function t(e){_classCallCheck(this,t),this.$active=null,this.focusCount=0,this.opsActive=!1,this.clickTimer=0,this.clickCount=0,this.events={allowFocus:new ExoEvent},this.admin=e,this.buildPanel(),this.buildOps()}return _createClass(t,[{key:"bind",value:function(){var i=this;u.Exo.event("reveal").on("alchemist",function(e){c(".exo-alchemist-component-edit:hover").each(function(e,t){c(t).trigger("mouseenter")})}),this.admin.event("overlayHide").on("exo.alchemist.component",function(e){i.hideOps()}),u.Exo.$window.on("exo-modal:onClosed.alchemist.component",function(e){setTimeout(function(){i.blur(),c(".exo-alchemist-component-edit:hover").each(function(e,t){i.focus(c(t))})})}),this.admin.getFieldOpsManager().event("allowFocus").on("exo.alchemist.field.ops",function(e){!0===i.opsActive&&(e.allow=!1)})}},{key:"attach",value:function(e){var t=this;c("#layout-builder").once("exo.alchemist.component").each(function(){t.refresh()}),c(".exo-alchemist-component-edit",e).once("exo.alchemist").on("mouseenter",function(e){t.lockFocus(),!1===t.opsActive&&(clearTimeout(t.activeTimer),t.activeTimer=setTimeout(function(){t.focus(c(e.currentTarget))},200))}).on("mouseleave",function(e){t.unlockFocus(),!1===t.opsActive&&(clearTimeout(t.activeTimer),t.activeTimer=setTimeout(function(){t.blur()},200))}).on("click",function(e){null===t.admin.getFieldOpsManager().getActive()&&(e.preventDefault(),e.stopPropagation(),t.clickCount++,clearTimeout(t.clickTimer),t.clickTimer=setTimeout(function(){1<t.clickCount&&t.accessOp("appearance")&&t.$active&&(t.admin.showOverlay(t.$active,"component"),t.triggerOp("appearance")),t.clickCount=0},300))})}},{key:"refresh",value:function(){this.blur(),c(".exo-alchemist-component-edit:hover").each(function(e,t){c(t).trigger("mouseenter")})}},{key:"buildPanel",value:function(){var t=this;this.$panel=c('<div class="exo-alchemist-component-panel" />').appendTo(u.Exo.$exoContent).on("mouseenter",function(e){t.lockFocus()}).on("mouseleave",function(e){t.unlockFocus(),!1===t.opsActive&&(clearTimeout(t.activeTimer),t.activeTimer=setTimeout(function(){t.hideOps(),t.blur()},200))}),c('<a href="#" title="Component Options" class="exo-alchemist-op exo-alchemist-component-panel-toggle"></a>').appendTo(this.$panel).on("click",function(e){e.preventDefault(),e.stopPropagation(),!1===t.opsActive?t.showOps():t.hideOps()});var i=e.debounce(function(){t.positionPanel()},100);u.Exo.$window.on("scroll.exo.alchemist",function(e){i()}),u.Exo.event("reveal").on("alchemist",function(e){i()})}},{key:"positionPanel",value:function(){var n=this;return new Promise(function(e,t){if(null!==n.$active&&void 0!==r){var i=u.Exo.$window.scrollTop()+r.offsets.top,o=n.$active.offset().top-r.offsets.top;o<i&&(o=i),n.$panel.css({top:o+"px",left:n.$active.offset().left+n.$active.outerWidth()-n.$panel.outerWidth()-r.offsets.left+"px"}),n.showPanel(),e()}else e()})}},{key:"showPanel",value:function(){null!==this.$active&&this.$panel.css({opacity:1,visibility:"visible"})}},{key:"hidePanel",value:function(){null!==this.$active&&this.$panel.css({opacity:0,visibility:"hidden"})}},{key:"buildOps",value:function(){var t=this,e=this.admin.opClasses;this.$ops=c('<div class="exo-alchemist-component-ops" />').on("mouseenter",function(e){t.lockFocus()}).on("mouseleave",function(e){t.unlockFocus()}).appendTo(this.$panel),this.ops={appearance:c('<a href="#" title="Appearance" class="'+e+' exo-alchemist-component-op-appearance hide"><span>Appearance</span></a>').data("op","appearance").appendTo(this.$ops),up:c('<a href="#" title="Move Up" class="'+e+' exo-alchemist-component-op-up hide"><span>Move Up</span></a>').data("op","up").appendTo(this.$ops),down:c('<a href="#" title="Move Down" class="'+e+' exo-alchemist-component-op-down hide"><span>Move Down</span></a>').data("op","down").appendTo(this.$ops),restore:c('<a href="#" title="Restore Empty Fields" class="'+e+' exo-alchemist-component-op-restore hide"><span>Restore</span></a>').data("op","restore").appendTo(this.$ops),remove:c('<a href="#" title="Remove" class="'+e+' exo-alchemist-component-op-remove hide"><span>Remove</span></a>').data("op","remove").appendTo(this.$ops)},this.$ops.find("a").on("click",function(e){e.preventDefault(),e.stopPropagation(),t.triggerOp(c(e.currentTarget).data("op"))})}},{key:"focus",value:function(e){var t=this,i={allow:!0};this.event("allowFocus").trigger(i),!0===i.allow&&(null!==this.$active&&this.$active!==e&&this.$active.removeClass("focus"),this.opsActive=!1,this.$panel.off(u.Exo.transitionEvent),this.$active=e,this.$active.addClass("focus"),this.positionPanel().then(function(){setTimeout(function(){t.$panel.addClass("animate")},50)}))}},{key:"blur",value:function(){var t=this;this.focusCount<=0&&(this.focusCount=0,this.$panel.one(u.Exo.transitionEvent,function(e){t.$panel.removeAttr("style").removeClass("animate"),t.$ops.find("a").addClass("hide")}),null!==this.$active&&this.$active.removeClass("focus"),this.hidePanel(),this.$active=null)}},{key:"lockFocus",value:function(){this.focusCount++}},{key:"unlockFocus",value:function(){this.focusCount--}},{key:"accessOp",value:function(e){var t=this.$active.data("exo-alchemist-delta");switch(e){case"up":return 0!==t;case"down":return this.admin.getComponentTotal()>t+1}return!0}},{key:"showOps",value:function(){var i=this;this.$panel.addClass("focus"),this.opsActive=!0,this.admin.showOverlay(this.$active,"component").then(function(){for(var e in i.admin.restrictOverlayPointerEvents(),i.ops)if(i.ops.hasOwnProperty(e)){var t=i.ops[e];!0===i.accessOp(e)?t.removeClass("hide"):t.addClass("hide")}i.$ops.removeClass("hide")})}},{key:"hideOps",value:function(){this.opsActive=!1,this.$panel.removeClass("focus")}},{key:"triggerOp",value:function(e){var o=this;if(this.$active){var t,i=this.$active.data("exo-alchemist-section"),n=this.$active.data("exo-alchemist-delta"),a="off_canvas",s={},l=null;switch(e){case"up":case"down":if(0<=(t="up"==e?n-2:n+1)){var r=c('.exo-alchemist-component-edit[data-exo-alchemist-delta="'+t+'"').data("exo-alchemist-section");l="layout_builder/move/block/"+this.admin.getStorageType()+"/"+this.admin.getStorageId()+"/"+this.admin.getSectionDelta()+"/"+this.admin.getSectionDelta()+"/"+this.admin.getSectionRegion()+"/"+i+"/"+r}else l="layout_builder/move/block/"+this.admin.getStorageType()+"/"+this.admin.getStorageId()+"/"+this.admin.getSectionDelta()+"/"+this.admin.getSectionDelta()+"/"+this.admin.getSectionRegion()+"/"+i;break;case"restore":case"remove":a=null,s.exo_modal={},s.exo_modal.icon="regular-question-circle",s.exo_modal.subtitle="Are you sure you want to proceed? This action cannot be undone.",l="layout_builder/"+e+"/block/"+this.admin.getStorageType()+"/"+this.admin.getStorageId()+"/"+this.admin.getSectionDelta()+"/"+this.admin.getSectionRegion()+"/"+i;break;case"appearance":s.exo_modal={},s.exo_modal.icon="regular-pencil-paintbrush",s.exo_modal.subtitle="Configure component appearance",s.exo_modal.overlayColor="transparent",l="layout_builder/"+e+"/block/"+this.admin.getStorageType()+"/"+this.admin.getStorageId()+"/"+this.admin.getSectionDelta()+"/"+this.admin.getSectionRegion()+"/"+i}l?u.ajax({url:u.url(l+"?destination="+u.url(d.path.currentPath)),dialog:s,dialogType:"dialog",dialogRenderer:a}).execute().done(function(e,t,i){o.admin.debug("info","Ajax request executed successfully.")}):this.admin.debug("info","URL was not build for operation."),this.hideOps()}}},{key:"event",value:function(e){return void 0!==this.events[e]?this.events[e].expose():null}},{key:"getActive",value:function(){return this.$active}}]),t}(),t=function(){function i(){var e;return _classCallCheck(this,i),(e=_possibleConstructorReturn(this,_getPrototypeOf(i).apply(this,arguments))).label="ExoAlchemistAdmin",e.doDebug=!1,e.ranOnce=!1,e.overlayVisible=!1,e.overlayCount=0,e.overlayTimer=null,e.highlightClasses=null,e.blaClasses=null,e.opClasses="exo-alchemist-op exo-alchemist-op-reset",e.events={overlayHide:new ExoEvent,overlayHidden:new ExoEvent},e}return _inherits(i,ExoDataManager),_createClass(i,[{key:"setup",value:function(){var t=this;_get(_getPrototypeOf(i.prototype),"build",this).call(this),this.buildOverlay(),this.componentManager=new s(this),this.fieldOpsManager=new n(this),this.fieldBreadcrumbsManager=new a(this),this.componentManager.bind(),this.fieldOpsManager.bind(),this.fieldBreadcrumbsManager.bind(),u.Exo.$exoBody.on("click.exo.achemist",function(e){c(e.target).closest(".exo-modal").length||t.hideOverlay()}),u.Exo.$document.on("keyup.exo.alchemist",function(e){t.overlayVisible&&27===e.keyCode&&t.hideOverlay()}),u.Exo.$window.on("exo-modal:onClosing.alchemist",function(e){t.hideOverlay()})}},{key:"attach",value:function(o){var a=this;return(this.ready=!1)===this.ranOnce&&(this.ranOnce=!0,this.setup()),new Promise(function(n,e){c("#layout-builder").once("exo.alchemist").each(function(){a.hideOverlay()});var t=c("[data-layout-builder-target-highlight-id]").first().attr("data-layout-builder-target-highlight-id");if(t){var i=c('[data-layout-builder-highlight-id="'+t+'"]').once("exo.alchemist.highlight");i.length&&a.showOverlay(i)}void 0!==d.exoAlchemist.fields&&c(".exo-component-field-edit",o).once("exo.alchemist").each(function(e,t){var i=JSON.parse(t.getAttribute("data-exo-alchemist-field"));if(void 0!==i.fieldName){jQuery.extend(i,d.exoAlchemist.fields[i.fieldName]);var o=u.Exo.guid();i.element=t,a.buildInstance(o,i),a.ready=!0,n(!0),a.debug("info","Attach: Finish",status)}}),a.componentManager.attach(o)})}},{key:"createInstance",value:function(e,t){return new o(e,this)}},{key:"buildOverlay",value:function(){var t=this;this.$mask=c('<div class="exo-alchemist-mask" />').appendTo(u.Exo.$exoContent),this.$overlay=c('<div class="exo-alchemist-overlay exo-font exo-reset" />').on("mouseenter",function(e){t.componentManager.lockFocus()}).on("mouseleave",function(e){t.componentManager.unlockFocus()}).appendTo(u.Exo.$exoContent)}},{key:"lockOverlay",value:function(){this.overlayCount++}},{key:"unlockOverlay",value:function(){this.overlayCount--}},{key:"showOverlay",value:function(o,n,a){var s=this;return new Promise(function(e,t){s.allowOverlayPointerEvents(),s.$overlay.off(u.Exo.transitionEvent),s.overlayVisible=!0,a=a||100,s.sizeOverlay(o),s.$mask.css("zIndex",a-1),s.$overlay.css("zIndex",a);var i=s.$overlay.data("op");i&&s.$overlay.removeClass("exo-overlay-op-"+i),n&&(s.$overlay.data("op",n),s.$overlay.addClass("exo-overlay-op-"+n)),u.Exo.$exoBody.addClass("exo-component-focus");clearTimeout(s.overlayTimer),function e(){s.sizeOverlay(o),s.overlayTimer=setTimeout(e,300)}(),e()})}},{key:"sizeOverlay",value:function(e){if(!0===this.overlayVisible){var t=e.outerWidth(!0),i=e.outerHeight(!0),o=e.offset(),n=o.top-r.offsets.top-e.css("marginTop").replace("px",""),a=n+i,s=o.left-r.offsets.left,l=s+t;this.$mask.css({top:"0px",right:"0px",bottom:"0px",left:"0px",width:"100%",height:"100%",opacity:1,visibility:"visible",clipPath:"polygon(0% 0%, 0% 100%, "+s+"px 100%, "+s+"px "+n+"px, "+l+"px "+n+"px, "+l+"px "+a+"px, "+s+"px "+a+"px, "+s+"px 100%, 100% 100%, 100% 0%)"}),this.$overlay.css({top:n+"px",left:s+"px",width:t+"px",height:i+"px",opacity:1,visibility:"visible"})}}},{key:"hideOverlay",value:function(){var o=this;return new Promise(function(t,e){if(o.overlayCount<=0&&!0===o.overlayVisible){clearTimeout(o.overlayTimer),o.overlayVisible=!1,o.$overlay.one(u.Exo.transitionEvent,function(e){o.$mask.removeAttr("style"),o.$overlay.removeAttr("style"),o.event("overlayHidden").trigger(o),t()}),o.$mask.css({opacity:0,visibility:"hidden"}),o.$overlay.css({opacity:0,visibility:"hidden"});var i=o.$overlay.data("op");i&&o.$overlay.removeClass("exo-overlay-op-"+i),o.event("overlayHide").trigger(o)}else t()})}},{key:"allowOverlayPointerEvents",value:function(){this.$mask.removeClass("restrict")}},{key:"restrictOverlayPointerEvents",value:function(){this.$mask.addClass("restrict")}},{key:"getEntityType",value:function(){return d.exoAlchemist.entityType}},{key:"getStorageType",value:function(){return d.exoAlchemist.storageType}},{key:"getStorageId",value:function(){return d.exoAlchemist.storageId}},{key:"getSectionDelta",value:function(){return d.exoAlchemist.sectionDelta}},{key:"getSectionRegion",value:function(){return d.exoAlchemist.sectionRegion}},{key:"getComponentTotal",value:function(){return d.exoAlchemist.componentTotal}},{key:"getOverlay",value:function(){return this.$overlay}},{key:"getFieldOpsManager",value:function(){return this.fieldOpsManager}},{key:"getComponentManager",value:function(){return this.componentManager}},{key:"event",value:function(e){return void 0!==this.events[e]?this.events[e].expose():null}}]),i}();u.ExoAlchemistAdmin=u.ExoAlchemistAdmin?u.ExoAlchemistAdmin:new t,u.behaviors.exoAlchemistAdmin={attach:function(e){void 0!==d.exoAlchemist&&u.ExoAlchemistAdmin.attach(e)}}}(jQuery,_,Drupal,drupalSettings,Drupal.displace);