"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}!function(h,e,d,p,u){var t=function(){function e(){_classCallCheck(this,e),this.label="ExoAlchemistAdmin",this.doDebug=!1,this.ranOnce=!1,this.overlapOffset=10,this.$activeTarget=null,this.$activeComponent=null,this.$activeField=null}return _createClass(e,[{key:"setup",value:function(){var t=this;this.buildElements(),d.Exo.$document.on("drupalViewportOffsetChange",function(e){t.$activeTarget&&!t.$activeComponent&&t.sizeTarget(t.$activeTarget)}),d.Exo.addOnResize("exo.alchemist",function(e){t.$activeComponent&&t.sizeComponentOverlay(t.$activeComponent),t.$activeField&&t.sizeFieldOverlay(t.$activeField),t.$activeTarget&&t.sizeTarget(t.$activeTarget)})}},{key:"buildElements",value:function(){this.$obtrusiveElements=h(".exo-fixed-region, .exo-layout-builder-top").addClass("exo-component-hide"),this.$shade=h('<div class="exo-alchemist-shade" />').appendTo(d.Exo.$exoContent),this.$highlight=h('<div class="exo-alchemist-highlight" />').appendTo(d.Exo.$exoContent),this.$overlay=h('<div class="exo-alchemist-overlay exo-reset exo-font" />').appendTo(d.Exo.$exoContent),this.$overlayHeader=h('<div class="exo-alchemist-overlay-header" />').appendTo(this.$overlay),this.$overlayOps=h("<span />").appendTo(this.$overlayHeader).wrap('<div class="exo-alchemist-ops exo-alchemist-overlay-ops" />'),this.$overlayClose=h('<div class="exo-alchemist-overlay-close" />').appendTo(this.$overlayHeader),this.$overlayClose.html("<a>"+p.exoAlchemist.icons.close+"</a>"),this.$target=h('<div class="exo-alchemist-target exo-reset exo-font" />').appendTo(d.Exo.$exoContent),this.$targetHeader=h('<div class="exo-alchemist-target-header" />').appendTo(this.$target),this.$targetTitle=h('<div class="exo-alchemist-target-title" />').appendTo(this.$target),this.$targetOps=h("<span />").appendTo(this.$targetHeader).wrap('<div class="exo-alchemist-ops exo-alchemist-target-ops" />'),this.$targetClose=h('<div class="exo-alchemist-target-close" />').appendTo(this.$targetHeader),this.$targetClose.html("<a>"+p.exoAlchemist.icons.close+"</a>"),this.$fieldBreadcrumbs=h('<ul class="exo-alchemist-breadcrumbs" />').appendTo(this.$overlay)}},{key:"attach",value:function(i){var n=this;return!1===this.ranOnce&&(this.ranOnce=!0,this.setup()),new Promise(function(e,t){function o(){h("#layout-builder").trigger("exo.alchemist.ready")}h("#layout-builder").once("exo.alchemist").each(function(e,t){if(n.$activeComponent&&!h(t).find(n.$activeComponent).length){var i=h("#"+n.$activeComponent.attr("id"));i.length?h(t).imagesLoaded(function(){if(n.setComponentActive(i,!0),n.$activeField&&!h(i).find(n.$activeField).length){var e=h("#"+n.$activeField.attr("id"));e.length&&n.setFieldActive(e,!0)}o()}):o()}else o()}),h(".exo-component-edit",i).once("exo.alchemist.component").each(function(e,t){var i=h(t),o=h(".exo-component-field-edit, .exo-section",i).length;i.hasClass("exo-component-locked")&&!o&&i.addClass("exo-component-blocked")}).on("click.exo.alchemist.component",function(e){var t=h(e.currentTarget);e.preventDefault(),e.stopPropagation(),t.hasClass("exo-component-blocked")||(n.setComponentActive(t,n.isNestedComponent(e.currentTarget)),h(".exo-component-field-edit:hover").trigger("mouseenter"))}).on("mouseenter.exo.alchemist.component",function(i){function e(){var e=h(i.currentTarget),t=JSON.parse(i.currentTarget.getAttribute("data-exo-component"));e.hasClass("exo-component-blocked")?n.showTarget(e,"This component cannot be changed.","regular-lock"):n.showTarget(e,"Click to focus this <strong>"+t.label.toLowerCase()+"</strong> component","regular-cog")}n.$activeComponent?n.isNestedComponent(i.currentTarget)&&e():e()}).on("mouseleave.exo.alchemist.component",function(e){n.$activeComponent?n.isNestedComponent(e.currentTarget)&&n.hideTarget():n.hideTarget()}),h(".exo-component-event-allow",i).once("exo.alchemist.allow").on("click.exo.alchemist.allow",function(e){if(!h(e.currentTarget).hasClass("exo-component-field-edit")){var t=h(e.currentTarget).closest(".exo-component-field-edit");t.length&&t.trigger("click")}n.watch()}),h(".exo-component-field-edit",i).once("exo.alchemist.field").on("click.exo.alchemist.field",function(e){var t=h(e.currentTarget);t.hasClass("exo-component-field-edit-lock")||t.closest(".exo-component-field-edit-lock").length||n.setFieldActive(t)}).on("mouseenter.exo.alchemist.field",function(e){if(!n.$activeField){var t=h(e.currentTarget);if(t.hasClass("exo-component-field-edit-lock")||t.closest(".exo-component-field-edit-lock").length)return;var i=JSON.parse(e.currentTarget.getAttribute("data-exo-field"));n.showTarget(t,"Click to manage <strong>"+i.label.toLowerCase()+"</strong> field","regular-cog")}}).on("mouseleave.exo.alchemist.field",function(e){n.$activeField||n.hideTarget()}),e(!0)})}},{key:"watch",value:function(){var a=this,e=[];e.push([this.$activeComponent,"sizeComponentOverlay"]),e.push([this.$activeField,"sizeFieldOverlay"]),e.push([this.$activeTarget,"sizeTarget"]),e.forEach(function(e){var i=e[0];if(i&&i.length){var o=e[1],n=0,s=Math.round(i.outerHeight(!0));!function t(){setTimeout(function(){var e=Math.round(i.outerHeight(!0));e!==s?(a[o](i),t()):(n<10&&t(),n++),s=e},10)}()}})}},{key:"isLayoutBuilder",value:function(){return p.exoAlchemist&&p.exoAlchemist.isLayoutBuilder}},{key:"setComponentActive",value:function(e,t){var i=this;this.$activeComponent&&!t||((this.$activeComponent=e).addClass("exo-component-edit-active"),this.$obtrusiveElements.length&&this.$obtrusiveElements.addClass("exo-component-hide-active"),this.buildComponentOps(e),this.hideTarget(),this.showComponentOverlay(e,function(){i.setComponentInactive()}))}},{key:"buildComponentOps",value:function(e){var t=p.exoAlchemist.componentOps,i=e.data("exo-component"),o=h.extend({},i);for(var n in this.$overlayOps.html(""),this.showComponentOps(),i.description&&h('<div class="exo-description exo-component-description">'+i.description+"</div>").appendTo(this.$overlayOps),t)if(t.hasOwnProperty(n)&&i.ops.includes(n)){var s=t[n],a=s.url;for(var l in o)o.hasOwnProperty(l)&&("string"!=typeof o[l]&&"number"!=typeof o[l]||(a=a.replace(new RegExp("-"+l+"-","g"),o[l])));var r=s.title;void 0!==i[n+"_badge"]&&(r+=' <span class="exo-alchemist-op-badge">'+i[n+"_badge"]+"</span>"),a=a.replace(new RegExp("(/-.*?)-","g"),"");var c=h('<a href="'+a+'" title="'+s.label+'" class="exo-component-op use-ajax">'+r+"</a>").appendTo(this.$overlayOps);c.data("dialog-type","dialog"),c.data("dialog-renderer","off_canvas"),c.data("dialog-options",{exo_modal:{title:s.label,subtitle:s.description,icon:s.icon}})}d.attachBehaviors(this.$overlayOps[0])}},{key:"showComponentOps",value:function(){this.$overlayOps.addClass("active")}},{key:"hideComponentOps",value:function(){this.$overlayOps.removeClass("active")}},{key:"isNestedComponent",value:function(e){return null!==this.$activeComponent&&0!==this.$activeComponent.find(e).length}},{key:"setComponentInactive",value:function(){if(this.$activeComponent){var e=this.$activeComponent.parent().closest(".exo-component-edit");if(this.setFieldInactive(),this.$activeComponent.removeClass("exo-component-edit-active"),this.$activeComponent=null,e.length)return void this.setComponentActive(e);this.hideTarget(),this.hideComponentOverlay(),this.hideComponentOps(),this.$obtrusiveElements.length&&this.$obtrusiveElements.removeClass("exo-component-hide-active")}}},{key:"showComponentOverlay",value:function(i,o){var n=this;return new Promise(function(e,t){n.restrictComponentOverlayPointerEvents(),n.sizeComponentOverlay(i),o&&(n.showOverlayClose(function(e){n.hideOverlayClose(),o()}),n.$shade.off("click").on("click.exo",function(e){e.target===n.$shade.get(0)&&o()})),e(!0)})}},{key:"showComponentClose",value:function(){this.$overlayClose.addClass("active")}},{key:"hideComponentClose",value:function(){this.$overlayClose.removeClass("active")}},{key:"hideComponentOverlay",value:function(){var i=this;return new Promise(function(t,e){i.hideComponentClose(),i.$shade.unbind("click.exo"),i.$overlay.one(d.Exo.transitionEvent,function(e){i.$shade.removeAttr("style"),i.$overlay.removeAttr("style"),t()}),i.$shade.css({opacity:0,visibility:"hidden"}),i.$overlay.css({opacity:0,visibility:"hidden"}),t(!0)})}},{key:"sizeComponentOverlay",value:function(e){var t=this,i=e.outerWidth(!0),o=e.outerHeight(!0),n=e.offset(),s=n.top-u.offsets.top-e.css("marginTop").replace("px",""),a=s+o,l=n.left-u.offsets.left-e.css("marginLeft").replace("px",""),r=l+i;this.$shade.css({top:"0px",right:"0px",bottom:"0px",left:"0px",width:"100%",height:"100%",visibility:"visible",clipPath:"polygon(0% 0%, 0% 100%, "+l+"px 100%, "+l+"px "+s+"px, "+r+"px "+s+"px, "+r+"px "+a+"px, "+l+"px "+a+"px, "+l+"px 100%, 100% 100%, 100% 0%)"}),setTimeout(function(){t.$shade.css("opacity",1)}),this.$overlay.css({top:s+"px",left:l+"px",width:i+"px",height:o+"px",opacity:1,visibility:"visible"})}},{key:"allowComponentOverlayPointerEvents",value:function(){this.$shade.removeClass("restrict")}},{key:"restrictComponentOverlayPointerEvents",value:function(){this.$shade.addClass("restrict")}},{key:"showTarget",value:function(e,t,i){clearTimeout(this.targetTimer),this.$target.off(d.Exo.transitionEvent),this.$activeTarget=e,i&&(t='<i class="exo-icon exo-icon-font icon-'+i+'" aria-hidden="true"></i> '+t),t=t?"<span>"+t+"</span>":"",this.$target.off(d.Exo.transitionEvent),t?(this.$targetTitle.addClass("active"),this.$targetTitle.html(t).show()):this.$targetTitle.removeClass("active"),this.sizeTarget(e)}},{key:"hideTarget",value:function(){var t=this;clearTimeout(this.targetTimer),this.targetTimer=setTimeout(function(){t.hideTargetClose(),t.$target.one(d.Exo.transitionEvent,function(e){t.$target.removeAttr("style")}),t.$activeTarget=null,t.$target.css({opacity:0,visibility:"hidden"})},200)}},{key:"showTargetClose",value:function(t){this.$targetClose.addClass("active"),t&&this.$targetClose.off("click").on("click.exo",function(e){e.preventDefault(),e.stopPropagation(),t(e)})}},{key:"hideTargetClose",value:function(){this.$targetClose.removeClass("active"),this.$targetClose.off("click.exo")}},{key:"allowTargetPointerEvents",value:function(){this.$target.removeClass("restrict")}},{key:"restrictTargetPointerEvents",value:function(){this.$target.addClass("restrict")}},{key:"sizeTarget",value:function(e){var t=d.Exo.$window.outerWidth(),i=e.offset(),o=e.outerWidth(!0),n=e.outerHeight(!0),s=i.top-u.offsets.top-e.css("marginTop").replace("px",""),a=i.left-u.offsets.left-e.css("marginLeft").replace("px","");if(this.$activeComponent){var l=this.$activeComponent.offset(),r=parseInt(this.$activeComponent.css("marginTop").replace("px",""));l.top-r>=i.top&&(s+=this.overlapOffset,a+=this.overlapOffset,o-=2*this.overlapOffset,n-=2*this.overlapOffset)}this.$target.css({top:s+"px",left:a+"px",width:o+"px",height:n+"px",opacity:1,visibility:"visible"}),this.$target.attr("data-align",t/2<a?"right":"left")}},{key:"lockNestedFields",value:function(e){e.addClass("exo-component-field-edit-lock")}},{key:"unlockNestedFields",value:function(e){e.removeClass("exo-component-field-edit-lock"),h(".exo-component-field-edit:hover").trigger("mouseenter")}},{key:"setFieldActive",value:function(e,t){var i=this;this.$activeField&&!t||((this.$activeField=e).addClass("exo-component-field-edit-active"),this.restrictTargetPointerEvents(),this.buildFieldOps(e),this.buildBreadcrumbs(),this.sizeComponentOverlay(this.$activeComponent),this.showFieldOverlay(e,function(){i.setFieldInactive()}),h(document).trigger("exoComponentFieldEditActive",this.$activeField))}},{key:"buildFieldOps",value:function(e){var t=p.exoAlchemist.fieldOps,i=e.closest(".exo-component-edit").data("exo-component"),o=e.data("exo-field"),n=h.extend({},i,o);for(var s in this.$targetOps.html(""),this.showFieldOps(),this.$targetOps.addClass("active"),o.description&&h('<div class="exo-description exo-field-description">'+o.description+"</div>").appendTo(this.$targetOps),t)if(t.hasOwnProperty(s)&&o.ops.includes(s)){var a=t[s],l=a.url;for(var r in n)n.hasOwnProperty(r)&&("string"!=typeof n[r]&&"number"!=typeof n[r]||(l=l.replace("-"+r+"-",n[r])));var c=h('<a href="'+l+'" title="'+a.label+'" class="exo-field-op use-ajax">'+a.title+"</a>").appendTo(this.$targetOps);c.data("dialog-type","dialog"),c.data("dialog-renderer","off_canvas"),c.data("dialog-options",{exo_modal:{title:a.label,subtitle:a.description,icon:a.icon}})}d.attachBehaviors(this.$targetOps[0])}},{key:"showFieldOps",value:function(){this.hideComponentOps(),this.hideComponentClose(),this.$targetOps.addClass("active")}},{key:"hideFieldOps",value:function(){this.showComponentOps(),this.showComponentClose(),this.$targetOps.removeClass("active")}},{key:"setFieldInactive",value:function(){this.$activeField&&(this.$activeField.removeClass("exo-component-field-edit-active"),this.$activeField=null,this.hideFieldOverlay(),this.hideFieldOps(),this.hideBreadcrumbs(),this.hideTarget(),this.allowTargetPointerEvents())}},{key:"showFieldOverlay",value:function(i,o){var n=this;return new Promise(function(e,t){n.$highlight.off(d.Exo.transitionEvent),n.showTarget(i),n.restrictFieldOverlayPointerEvents(),n.sizeFieldOverlay(i),o&&(n.showTargetClose(function(e){n.hideTargetClose(),o()}),n.$highlight.off("click").on("click.exo",function(e){e.preventDefault(),e.stopPropagation(),e.target===n.$highlight.get(0)&&o()})),e(!0)})}},{key:"allowFieldOverlayPointerEvents",value:function(){this.$highlight.removeClass("restrict")}},{key:"restrictFieldOverlayPointerEvents",value:function(){this.$highlight.addClass("restrict")}},{key:"hideFieldOverlay",value:function(){var i=this;return new Promise(function(t,e){i.hideTargetClose(),i.$highlight.unbind("click.exo"),i.$highlight.one(d.Exo.transitionEvent,function(e){i.$highlight.removeAttr("style"),t()}),i.$highlight.css({opacity:0,visibility:"hidden"}),t(!0)})}},{key:"sizeFieldOverlay",value:function(e){var t=this,i=this.$activeComponent.offset(),o=this.$activeComponent.outerWidth(!0),n=this.$activeComponent.outerHeight(!0),s=i.top-parseInt(this.$activeComponent.css("marginTop").replace("px","")),a=i.left-parseInt(this.$activeComponent.css("marginLeft").replace("px","")),l=e.outerWidth(!0),r=e.outerHeight(!0),c=e.offset(),h=c.top-s-e.css("marginTop").replace("px",""),d=h+r,p=c.left-a-e.css("marginLeft").replace("px",""),v=p+l;this.$highlight.css({top:s-u.offsets.top+"px",bottom:s+n+"px",left:a-u.offsets.left+"px",right:a+o+"px",width:o,height:n,visibility:"visible",clipPath:"polygon(0% 0%, 0% 100%, "+p+"px 100%, "+p+"px "+h+"px, "+v+"px "+h+"px, "+v+"px "+d+"px, "+p+"px "+d+"px, "+p+"px 100%, 100% 100%, 100% 0%)"}),setTimeout(function(){t.$highlight.css("opacity",1)},10)}},{key:"showOverlayClose",value:function(t){this.$overlayClose.addClass("active"),t&&this.$overlayClose.off("click.exo").on("click.exo",function(e){e.preventDefault(),e.stopPropagation(),t(e)})}},{key:"hideOverlayClose",value:function(){this.$overlayClose.removeClass("active"),this.$overlayClose.off("click.exo")}},{key:"buildBreadcrumbs",value:function(){var n=this;if(this.hideBreadcrumbs(),this.$activeField){var e=this.$activeField,t=this.$activeComponent.find(".exo-component-field-edit"),i=(t=(t=(t=t.not(e.find(".exo-component-field-edit"))).not(e.parents(".exo-component-group").find(".exo-component-field-edit"))).add(e.parents(".exo-component-field-edit"))).overlaps(e).add(e);h('<li class="exo-alchemist-breadcrumb-label">Nested Elements:</li>').appendTo(this.$fieldBreadcrumbs),i.each(function(e,t){var i=h(t),o=i.data("exo-field");h('<li class="exo-alchemist-breadcrumb-field"><a>'+o.label+"</a></li>").on("click",function(e){e.preventDefault(),e.stopPropagation(),n.setFieldInactive(),n.setFieldActive(i,!0)}).appendTo(n.$fieldBreadcrumbs)})}}},{key:"hideBreadcrumbs",value:function(){this.$fieldBreadcrumbs.children().remove()}}]),e}();d.ExoAlchemistAdmin=d.ExoAlchemistAdmin?d.ExoAlchemistAdmin:new t,d.behaviors.exoAlchemistAdmin={attach:function(e){d.ExoAlchemistAdmin.attach(e)}},d.AjaxCommands.prototype.exoComponentFocus=function(e,t,i){var o=h("#"+t.id);o.length&&h("#layout-builder").on("exo.alchemist.ready",function(e){d.ExoAlchemistAdmin.setComponentActive(o,!0)})},d.AjaxCommands.prototype.exoComponentBlur=function(e,t,i){d.ExoAlchemistAdmin.setComponentInactive()},d.AjaxCommands.prototype.exoComponentFieldFocus=function(e,t,i){var o=h("#"+t.id);o.length&&h("#layout-builder").on("exo.alchemist.ready",function(e){d.ExoAlchemistAdmin.setFieldActive(o,!0)})},d.AjaxCommands.prototype.exoComponentFieldBlur=function(e,t,i){d.ExoAlchemistAdmin.setFieldInactive()}}(jQuery,_,Drupal,drupalSettings,Drupal.displace);