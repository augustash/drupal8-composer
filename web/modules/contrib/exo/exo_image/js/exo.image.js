"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}var ExoImage=function(){function e(){_classCallCheck(this,e),this.isBuilt=!1,this.supportsWebP=!1,this.defaults={ratio_distortion:60,upscale:320,downscale:1900,multiplier:1,animate:1,bg:0,visible:1,handler:"scale",ratio:{width:1,height:1}}}return _createClass(e,[{key:"attach",value:function(i){var a=this;return new Promise(function(e,t){!1===a.isBuilt?(a.build(i),!0===drupalSettings.exoImage.defaults.webp?a.checkSupportForWebP().then(function(){a.supportsWebP=!0,a.init(i),e(!0)},function(){a.init(i),e(!0)}):(a.init(i),e(!0))):(a.init(i),e(!0))})}},{key:"build",value:function(e){var t=this;this.isBuilt=!0,Drupal.Exo.event("breakpoint").on("exo.image",function(e){t.init()}),Drupal.Exo.$window.on("resize.exo.image",_.debounce(function(){"xlarge"===Drupal.Exo.breakpoint.name&&t.init()},200)),this.triggerResize=_.debounce(function(){Drupal.Exo.$window.trigger("resize")},200)}},{key:"init",value:function(e){var t=this;void 0===e&&(e=document);var i=e.querySelectorAll(".exo-image");if(0<i.length)for(var a=0;a<i.length;a++){if(!this.isHidden(i[a]))1===this.fetchData(i[a]).visible&&null===i[a].getAttribute("data-w")?Drupal.Exo.trackElementPosition(i[a],function(e){Drupal.Exo.untrackElementPosition(e[0]),t.renderEl(e[0])}):this.renderEl(i[a])}}},{key:"isHidden",value:function(e){return"none"===window.getComputedStyle(e).display}},{key:"fetchData",value:function(e){var t=JSON.parse(e.getAttribute("data-exo-image"));for(var i in drupalSettings.exoImage.defaults)drupalSettings.exoImage.defaults.hasOwnProperty(i)&&void 0===t[i]&&(t[i]=drupalSettings.exoImage.defaults[i]);for(var a in this.defaults)this.defaults.hasOwnProperty(a)&&void 0===t[a]&&(t[a]=this.defaults[a]);return Drupal.Exo.isIE()&&(t.animate=0,t.visible=0),0===e.offsetWidth&&(t.visible=1),Drupal.Exo.cleanData(t,this.defaults)}},{key:"renderEl",value:function(i){var a=this.fetchData(i);if(!1===isNaN(a.fid)&&a.fid%1==0&&0<Number(a.fid)){var e=this.size(i),t=Number(i.getAttribute("data-w")),n=Number(i.getAttribute("data-h"));if((e[0]!==t||e[1]!==n)&&0<e[0]){var r=i.querySelector&&i.querySelector("img.exo-image-preview"),o="/images/"+e[0]+"/"+e[1]+"/"+a.fid+"/"+encodeURIComponent(a.filename);this.supportsWebP&&(o=o.substr(0,o.lastIndexOf("."))+".webp"),i.setAttribute("data-w",e[0].toString()),i.setAttribute("data-h",e[1].toString());var u=0,l=new Image;l.className="exo-image-reveal exo-image-actual",l.width=e[0],l.height=e[1],l.onload=function(e){var t=i.querySelector&&i.querySelector("img.exo-image-actual");t&&(t.parentNode.removeChild(t),a.animate=0),i.appendChild(l),1===a.bg?(l.style.visibility="hidden",l.classList.remove("exo-image-reveal"),i.style.backgroundImage='url("'+o+'")',1===a.animate?setTimeout(function(){r.classList.add("exo-image-fadeout"),r.addEventListener(Drupal.Exo.animationEvent,function(e){r.parentNode.removeChild(r),r.removeEventListener(Drupal.Exo.animationEvent,function(e){})})},50):r&&setTimeout(function(){r.parentNode.removeChild(r)},50)):1===a.animate?(r&&r.classList.add("exo-image-float"),l.addEventListener(Drupal.Exo.animationEvent,function(e){r&&r.parentNode.removeChild(r),l.removeEventListener(Drupal.Exo.animationEvent,function(e){}),l.classList.remove("exo-image-reveal")})):(r&&r.parentNode.removeChild(r),l.classList.remove("exo-image-reveal"))},l.onerror=function(e){++u<3&&l.setAttributeNS("http://www.w3.org/1999/xlink","href",o)},l.src=o,this.triggerResize()}}}},{key:"size",value:function(e){if(0===e.offsetWidth)return{0:0,1:0};var t=this.fetchData(e),i=Drupal.Exo.getPxFromEm(Drupal.Exo.getMeasurementValue(Drupal.Exo.breakpoint.max)),a=document.documentElement.clientWidth>i?i:document.documentElement.clientWidth,n=Math.round(e.offsetWidth/a*10)/10,r={0:Math.ceil(i*n),1:0};"xlarge"===Drupal.Exo.breakpoint.name&&(r[0]=Math.round(100*e.offsetWidth)/100),r[0]===document.documentElement.clientWidth&&(r[0]=Drupal.Exo.getPxFromEm(Drupal.Exo.breakpoint.max));var o=1;return 1===t.multiplier&&(o=Number(window.devicePixelRatio),(!0===isNaN(o)||o<=0)&&(o=1)),r[0]=Math.round(r[0]*o),r[0]<t.upscale&&(r=this.resize(r,t.upscale,0)),r[0]>t.downscale&&(r=this.resize(r,t.downscale,0)),r[0]=20*Math.ceil(r[0]/20),"ratio"===t.handler&&(r[1]=Math.round(r[0]*t.thumb_ratio)),r}},{key:"resize",value:function(e,t,i){if(0===e[i])return e;var a={0:e[0],1:e[1]};a[i]=t;var n=Math.abs(i-1);return 0===e[n]||(a[n]=Math.round(a[n]*(a[i]/e[i]))),a}},{key:"checkSupportForWebP",value:function(a){var n={basic:"data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAACyAgCdASoCAAEALmk0mk0iIiIiIgBoSygABc6zbAAA/v56QAAAAA==",lossless:"data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="};return new Promise(function(e,t){var i=new Image;i.onload=function(){e()},i.onerror=function(){t()},i.src=n[a||"basic"]})}}]),e}();Drupal.ExoImage=new ExoImage,function(t){t.behaviors.exoImage={attach:function(e){t.ExoImage.attach(e)}}}(Drupal,drupalSettings);